<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Instagram - Dezembro</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f2f2f2;
            padding: 20px;
        }
        h1 {
            text-align: center;
            font-size: 28px;
        }
        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }
        select, button {
            padding: 10px;
            font-size: 16px;
        }

        .kpis {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 20px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }

        table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            margin-top: 30px;
            border-radius: 10px;
            overflow: hidden;
        }
        table th, table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background: #333;
            color: white;
        }

        .charts {
            margin-top: 40px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
        }
        canvas {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<h1>Dashboard Instagram - Dezembro</h1>

<div class="filters">
    <select id="unitFilter"></select>
    <button onclick="loadData()">Atualizar</button>
</div>

<div class="kpis">
    <div class="card" id="kpiDirects">Directs: 0</div>
    <div class="card" id="kpiRespostas">Respostas: 0</div>
    <div class="card" id="kpiAgendamentos">Agendamentos: 0</div>
    <div class="card" id="kpiComparecimentos">Comparecimentos: 0</div>
    <div class="card" id="kpiVendas">Vendas: 0</div>
    <div class="card" id="kpiConversao">Conversão Final: 0%</div>
</div>

<h2>Resumo por Unidade</h2>
<table id="resultTable">
    <thead>
        <tr>
            <th>Unidade</th>
            <th>Directs</th>
            <th>Respostas</th>
            <th>Agendamentos</th>
            <th>Comparecimentos</th>
            <th>Vendas</th>
            <th>Conversão (%)</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="charts">
    <canvas id="directsChart"></canvas>
    <canvas id="vendasChart"></canvas>
</div>

<script>

const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSjDEbxS9ieNObM4lVDYcZ_E9tzuDvf92I8e0VEJCrkByw2r9gHUiUsWWGkE65J97dkiO0Ind8GEoju/pub?gid=308040371&single=true&output=csv";

let rawData = [];

let directsChart;
let vendasChart;

async function loadData() {
    const response = await fetch(CSV_URL + "&t=" + Date.now()); // força atualização real-time
    const csvText = await response.text();
    const lines = csvText.split("\n").map(l => l.split(","));

    rawData = lines.slice(1).filter(r => r[0].trim() !== "").map(r => ({
        unidade: r[0],
        directs: Number(r[1]),
        respostas: Number(r[2]),
        agendamentos: Number(r[3]),
        comparecimentos: Number(r[4]),
        vendas: Number(r[5])
    }));

    updateUnitFilter();
    updateDashboard();
    updateCharts();
}

function updateUnitFilter() {
    const select = document.getElementById("unitFilter");
    if (select.options.length === 0) {
        select.innerHTML = `<option value="TODAS">Todas Unidades</option>`;
        rawData.forEach(row => {
            select.innerHTML += `<option value="${row.unidade}">${row.unidade}</option>`;
        });
    }
}

function updateDashboard() {
    const selected = document.getElementById("unitFilter").value;

    const filtered = selected === "TODAS" ? rawData : rawData.filter(r => r.unidade === selected);

    const totals = {
        directs: filtered.reduce((a,b) => a + b.directs, 0),
        respostas: filtered.reduce((a,b) => a + b.respostas, 0),
        agendamentos: filtered.reduce((a,b) => a + b.agendamentos, 0),
        comparecimentos: filtered.reduce((a,b) => a + b.comparecimentos, 0),
        vendas: filtered.reduce((a,b) => a + b.vendas, 0),
    };

    document.getElementById("kpiDirects").innerText = `Directs: ${totals.directs}`;
    document.getElementById("kpiRespostas").innerText = `Respostas: ${totals.respostas}`;
    document.getElementById("kpiAgendamentos").innerText = `Agendamentos: ${totals.agendamentos}`;
    document.getElementById("kpiComparecimentos").innerText = `Comparecimentos: ${totals.comparecimentos}`;
    document.getElementById("kpiVendas").innerText = `Vendas: ${totals.vendas}`;

    const conv = totals.directs > 0 ? ((totals.vendas / totals.directs) * 100).toFixed(1) : 0;
    document.getElementById("kpiConversao").innerText = `Conversão Final: ${conv}%`;

    const tbody = document.querySelector("#resultTable tbody");
    tbody.innerHTML = "";

    filtered.forEach(r => {
        const conv = r.directs > 0 ? ((r.vendas / r.directs) * 100).toFixed(1) : 0;

        tbody.innerHTML += `
            <tr>
                <td>${r.unidade}</td>
                <td>${r.directs}</td>
                <td>${r.respostas}</td>
                <td>${r.agendamentos}</td>
                <td>${r.comparecimentos}</td>
                <td>${r.vendas}</td>
                <td>${conv}%</td>
            </tr>`;
    });
}

function updateCharts() {
    const labels = rawData.map(r => r.unidade);
    const directs = rawData.map(r => r.directs);
    const vendas = rawData.map(r => r.vendas);

    const ctx1 = document.getElementById("directsChart");
    const ctx2 = document.getElementById("vendasChart");

    if (directsChart) directsChart.destroy();
    if (vendasChart) vendasChart.destroy();

    directsChart = new Chart(ctx1, {
        type: "bar",
        data: {
            labels,
            datasets: [{
                label: "Directs",
                data: directs
            }]
        }
    });

    vendasChart = new Chart(ctx2, {
        type: "bar",
        data: {
            labels,
            datasets: [{
                label: "Vendas",
                data: vendas
            }]
        }
    });
}

// Auto-update every 10 seconds
setInterval(loadData, 10000);

loadData();

</script>
</body>
</html>
